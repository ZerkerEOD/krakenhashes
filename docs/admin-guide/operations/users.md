# User Management Guide

This guide covers user administration in KrakenHashes, including user roles, authentication, multi-factor authentication (MFA), and security policies.

## Table of Contents

1. [User Roles and Permissions](#user-roles-and-permissions)
2. [Creating and Managing Users](#creating-and-managing-users)
3. [Password Policies and Requirements](#password-policies-and-requirements)
4. [Multi-Factor Authentication Management](#multi-factor-authentication-management)
5. [Session Management](#session-management)
6. [User Deactivation and Deletion](#user-deactivation-and-deletion)
7. [Audit Logging and User Activity](#audit-logging-and-user-activity)

## User Roles and Permissions

KrakenHashes implements a role-based access control (RBAC) system with the following roles:

### User Roles

1. **User** (default role)
   - View and manage their own profile
   - Submit password cracking jobs
   - View their own job results
   - Manage their own MFA settings
   - Access general system features

2. **Admin**
   - All user permissions plus:
   - View and manage all users
   - Reset user passwords
   - Enable/disable user accounts
   - Modify system settings
   - View all jobs and results
   - Manage agents and vouchers
   - Access admin dashboard

3. **System** (special role)
   - Reserved for system operations
   - Cannot be assigned to regular users
   - Cannot be modified or disabled

### Permission Matrix

| Action | User | Admin | System |
|--------|------|-------|---------|
| View own profile | ✓ | ✓ | ✓ |
| Edit own profile | ✓ | ✓ | ✓ |
| View all users | ✗ | ✓ | ✓ |
| Manage users | ✗ | ✓ | ✗ |
| System settings | ✗ | ✓ | ✗ |
| View all jobs | ✗ | ✓ | ✓ |

## Creating and Managing Users

### User Creation

Currently, users are created through the registration process. Admin creation of users is not directly implemented but can be achieved through the following methods:

1. **Self-Registration** (if enabled)
   - Users register themselves through the web interface
   - Email verification may be required

2. **Admin-Initiated Registration**
   - Admin provides registration link to new users
   - User completes registration process

### User Management Operations

#### Listing Users
Admins can view all users through the admin dashboard:
- Navigate to Admin → Users
- Filter by role (admin, user)
- View user details including:
  - Username and email
  - Role
  - Account status (enabled/disabled)
  - MFA status
  - Last login time

#### Updating User Information
Admins can update:
- Username
- Email address
- User role (user ↔ admin)

**Note:** System users cannot be modified.

#### Resetting User Passwords
Admins can reset user passwords in two ways:

1. **Temporary Password**
   - System generates a secure temporary password
   - Password must be changed on next login
   - Share password securely with user

2. **Custom Password**
   - Admin sets a specific password
   - Must meet password policy requirements
   - User should change on next login

## Password Policies and Requirements

### Default Password Requirements

The system enforces configurable password policies:

- **Minimum Length**: 8 characters (configurable)
- **Character Requirements** (configurable):
  - Uppercase letters
  - Lowercase letters
  - Numbers
  - Special characters

### Password Policy Configuration

Admins can configure password policies via:
1. Navigate to Admin → Settings → Authentication
2. Adjust password requirements:
   ```json
   {
     "minPasswordLength": 8,
     "requireUppercase": true,
     "requireLowercase": true,
     "requireNumbers": true,
     "requireSpecialChars": true
   }
   ```

### Password Security Features

- Passwords are hashed using bcrypt with default cost
- Password history tracking
- Last password change timestamp
- Forced password change capability

## Multi-Factor Authentication Management

### MFA Overview

KrakenHashes supports multiple MFA methods:

1. **Email-based MFA** (default)
   - 6-digit codes sent via email
   - Configurable code validity period
   - Built-in cooldown between requests

2. **Authenticator App (TOTP)**
   - Compatible with Google Authenticator, Authy, etc.
   - SHA-512 algorithm
   - 30-second time window
   - 6-digit codes

3. **Backup Codes**
   - 8 single-use recovery codes (configurable)
   - Generated when MFA is enabled
   - Can be regenerated by user

### Global MFA Settings

Admins can configure MFA requirements:

1. **Mandatory MFA**
   - Require all users to enable MFA
   - Configurable allowed methods
   - Email gateway must be configured first

2. **MFA Configuration Options**
   ```json
   {
     "requireMfa": false,
     "allowedMfaMethods": ["email", "authenticator"],
     "emailCodeValidity": 5,        // minutes
     "backupCodesCount": 8,
     "mfaCodeCooldownMinutes": 1,
     "mfaCodeExpiryMinutes": 5,
     "mfaMaxAttempts": 3
   }
   ```

### User MFA Management

#### Enabling MFA for a User
Users can enable MFA through their profile:
1. Navigate to Profile → Security
2. Choose MFA method
3. Complete verification process
4. Save backup codes

#### Admin MFA Operations
Admins can:
- View user MFA status
- Disable MFA for a user (if not globally required)
- Reset MFA settings in case of lockout

### MFA Authentication Flow

1. User enters username/password
2. System validates credentials
3. If MFA enabled, prompt for code
4. User provides code via preferred method
5. System validates code with retry limits
6. Grant access upon successful verification

## Session Management

### Session Security Features

1. **JWT-based Authentication**
   - Configurable token expiry (default: 7 days)
   - Secure HTTP-only cookies
   - Refresh token support

2. **Account Security**
   - Failed login attempt tracking
   - Automatic account lockout after threshold
   - Configurable lockout duration
   - Admin unlock capability

### Session Configuration

```json
{
  "maxFailedAttempts": 5,
  "lockoutDurationMinutes": 30,
  "jwtExpiryMinutes": 10080,  // 7 days
  "sessionTimeout": 60         // minutes of inactivity
}
```

### Managing User Sessions

#### Account Lockout
When a user exceeds failed login attempts:
1. Account is automatically locked
2. User sees lockout message with duration
3. Admin can manually unlock via Admin → Users → Unlock

#### Session Monitoring
- Last login timestamp tracked
- Failed login attempts counted
- Last failed attempt timestamp
- Account lock status and duration

## User Deactivation and Deletion

### Account Deactivation

Admins can disable user accounts:

1. **Disable Account**
   - User cannot log in
   - Requires disable reason
   - Tracks who disabled and when
   - Account data preserved
   - Can be re-enabled later

2. **Enable Account**
   - Restores account access
   - Clears disable reason
   - User can log in again

### Important Considerations

- System users cannot be disabled
- Disabled users' data remains intact
- Active sessions are not immediately terminated
- User deletion is not implemented (data retention)

### Deactivation Process

1. Navigate to Admin → Users
2. Select user to disable
3. Click "Disable Account"
4. Provide reason for audit trail
5. Confirm action

To re-enable:
1. Find disabled user
2. Click "Enable Account"
3. User can now log in

## Audit Logging and User Activity

### User Activity Tracking

The system tracks the following user activities:

1. **Authentication Events**
   - Login attempts (successful/failed)
   - MFA verification attempts
   - Password changes
   - Account lockouts

2. **Account Modifications**
   - Profile updates
   - MFA changes
   - Password resets
   - Role changes

3. **Administrative Actions**
   - User account modifications
   - Password resets by admin
   - Account enable/disable
   - MFA resets

### Audit Information Captured

For each auditable event:
- Timestamp
- User ID performing action
- Target user ID (if applicable)
- Action type
- Additional context (e.g., disable reason)
- IP address (where applicable)

### Accessing Audit Logs

While a dedicated audit log viewer is not yet implemented, audit information is stored in the database:

- Login tracking via `last_login` and `failed_login_attempts`
- Account changes via `disabled_by`, `disabled_at`, `disabled_reason`
- Password changes via `last_password_change`

### Security Best Practices

1. **Regular Reviews**
   - Review user list for inactive accounts
   - Check for users with excessive privileges
   - Monitor failed login patterns

2. **MFA Enforcement**
   - Consider mandatory MFA for admin users
   - Regular review of MFA methods in use
   - Ensure email gateway configured for email MFA

3. **Password Policies**
   - Enforce strong password requirements
   - Consider regular password rotation for admins
   - Monitor for compromised credentials

4. **Account Hygiene**
   - Disable accounts promptly when users leave
   - Regular review of admin role assignments
   - Document reasons for account actions

## Troubleshooting Common Issues

### MFA Issues

**Problem**: User locked out of MFA
- **Solution**: Admin can disable MFA for user, user re-enables

**Problem**: Email codes not received
- **Solution**: Check email gateway configuration, verify email address

**Problem**: Authenticator app out of sync
- **Solution**: Verify system time, consider increasing TOTP skew tolerance

### Account Access Issues

**Problem**: User account locked
- **Solution**: Admin unlocks account or wait for lockout duration

**Problem**: Password reset not working
- **Solution**: Verify password meets policy requirements

**Problem**: Cannot modify system user
- **Solution**: System users are protected and cannot be modified

### Configuration Issues

**Problem**: Cannot enable global MFA
- **Solution**: Configure email gateway first in Email Settings

**Problem**: Users bypassing MFA
- **Solution**: Check global MFA requirement is enabled

## API Endpoints Reference

For programmatic access, the following admin endpoints are available:

- `GET /api/admin/users` - List all users
- `GET /api/admin/users/{id}` - Get user details
- `PUT /api/admin/users/{id}` - Update user
- `POST /api/admin/users/{id}/disable` - Disable account
- `POST /api/admin/users/{id}/enable` - Enable account
- `POST /api/admin/users/{id}/reset-password` - Reset password
- `POST /api/admin/users/{id}/disable-mfa` - Disable MFA
- `POST /api/admin/users/{id}/unlock` - Unlock account

All endpoints require admin authentication via JWT token.