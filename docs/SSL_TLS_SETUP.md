# SSL/TLS Setup Guide for KrakenHashes

This guide explains how to set up and trust the self-signed SSL certificates used by KrakenHashes on various platforms.

## Overview

KrakenHashes uses self-signed certificates by default to secure communications between components. When you first access the web interface, your browser will warn you about the untrusted certificate. This is expected behavior for self-signed certificates.

To avoid these warnings, you need to install the KrakenHashes Certificate Authority (CA) certificate as a trusted root certificate on your system.

## Downloading the CA Certificate

The CA certificate can be downloaded from:
- **HTTP endpoint**: `http://your-server:1337/ca.crt`
- **Via the web interface**: When you see the certificate warning, there's usually an option to download the CA certificate

Save the file as `krakenhashes-ca.crt` for the following instructions.

## Installation Instructions by Platform

### Linux Systems

#### Debian/Ubuntu

1. Copy the CA certificate to the system certificate directory:
   ```bash
   sudo cp krakenhashes-ca.crt /usr/local/share/ca-certificates/
   ```

2. Update the certificate store:
   ```bash
   sudo update-ca-certificates
   ```

3. You should see output indicating the certificate was added:
   ```
   Updating certificates in /etc/ssl/certs...
   1 added, 0 removed; done.
   ```

#### Fedora/RHEL/CentOS/Rocky Linux

1. Copy the CA certificate to the trust anchors directory:
   ```bash
   sudo cp krakenhashes-ca.crt /etc/pki/ca-trust/source/anchors/
   ```

2. Update the trust store:
   ```bash
   sudo update-ca-trust
   ```

#### Arch Linux

**Using trust anchor command (Recommended):**
```bash
# This is the official Arch way - it handles everything automatically
sudo trust anchor --store krakenhashes-ca.crt
```

Note: The `trust anchor --store` command automatically:
- Places the certificate in `/etc/ca-certificates/trust-source/anchors/`
- Updates the trust database with `update-ca-trust`
- Handles p11-kit integration properly

#### Additional Step for Chrome/Chromium on Linux

Chrome and Chromium browsers maintain their own certificate store on Linux. After installing the system certificate, you also need to:

1. Install the certificate in the NSS database:
   ```bash
   certutil -d sql:$HOME/.pki/nssdb -A -t "CP,CP," -n "KrakenHashes Root CA" -i krakenhashes-ca.crt
   ```

2. Restart Chrome/Chromium for the changes to take effect.

To verify the certificate was installed:
```bash
certutil -d sql:$HOME/.pki/nssdb -L
```

To remove the certificate later if needed:
```bash
certutil -d sql:$HOME/.pki/nssdb -D -n "KrakenHashes Root CA"
```

### Windows

#### Using Certificate Manager (GUI)

1. Press `Win + R`, type `certmgr.msc`, and press Enter
2. Navigate to "Trusted Root Certification Authorities" > "Certificates"
3. Right-click on "Certificates" and select "All Tasks" > "Import..."
4. Follow the Certificate Import Wizard:
   - Click "Next"
   - Browse and select the `krakenhashes-ca.crt` file
   - Click "Next"
   - Ensure "Place all certificates in the following store" is selected with "Trusted Root Certification Authorities"
   - Click "Next" and then "Finish"
5. When prompted with a security warning, click "Yes" to install the certificate

#### Using PowerShell (Administrator)

```powershell
# Import the certificate to the Trusted Root store
Import-Certificate -FilePath "C:\path\to\krakenhashes-ca.crt" -CertStoreLocation Cert:\LocalMachine\Root
```

#### Using Command Prompt (Administrator)

```cmd
certutil -addstore "Root" "C:\path\to\krakenhashes-ca.crt"
```

### macOS

#### Using Keychain Access (GUI)

1. Double-click the `krakenhashes-ca.crt` file
2. Keychain Access will open
3. Select "System" keychain (you may need to authenticate)
4. The certificate will be added but marked as untrusted
5. Double-click on the "KrakenHashes Root CA" certificate
6. Expand the "Trust" section
7. Change "When using this certificate" to "Always Trust"
8. Close the window and authenticate to save changes

#### Using Command Line

```bash
# Add certificate to system keychain
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain krakenhashes-ca.crt
```

## Verification

After installing the certificate, you can verify it's working:

1. **Browser Test**: Navigate to `https://your-server:31337` - you should no longer see certificate warnings
2. **Command Line Test**: 
   ```bash
   curl https://your-server:31337/health
   # Should work without certificate errors
   ```

## Certificate Details

The self-signed certificates generated by KrakenHashes include:

- **CA Certificate**: Valid for 10 years (3650 days)
- **Server Certificate**: Valid for 1 year (365 days)
- **Key Size**: 4096-bit RSA (configurable)
- **Extensions**: 
  - SubjectKeyIdentifier and AuthorityKeyIdentifier for proper chain validation
  - BasicConstraints properly set (CA:TRUE for CA, CA:FALSE for server)
  - Appropriate KeyUsage and ExtendedKeyUsage flags

## Environment Variables

You can customize certificate generation with these environment variables:

- `KH_ADDITIONAL_DNS_NAMES`: Comma-separated additional DNS names (e.g., "krakenhashes.local,kraken.internal")
- `KH_ADDITIONAL_IP_ADDRESSES`: Comma-separated additional IP addresses (e.g., "192.168.1.100,10.0.0.50")
- `KH_CERT_KEY_SIZE`: RSA key size (2048 or 4096, default: 4096)
- `KH_CERT_VALIDITY_DAYS`: Server certificate validity in days (default: 365)
- `KH_CA_VALIDITY_DAYS`: CA certificate validity in days (default: 3650)

## Security Considerations

1. **Self-signed certificates** are suitable for:
   - Development environments
   - Internal networks
   - Testing and staging
   - Environments where you control all clients

2. **For production use**, consider:
   - Using certificates from a trusted CA (Let's Encrypt, etc.)
   - Implementing proper certificate rotation
   - Using the `certbot` mode if you have a public domain

3. **Certificate Storage**:
   - Private keys are stored with 0600 permissions
   - Certificates are stored in the configured certs directory
   - Default location: `~/.krakenhashes/certs/` or `/etc/krakenhashes/certs/` in Docker

## Regenerating Certificates

If you need to regenerate certificates (e.g., to add new SANs):

1. Stop the KrakenHashes backend
2. Delete the existing certificates:
   ```bash
   rm -rf ~/.krakenhashes/certs/*
   # Or your configured certs directory
   ```
3. Start the backend - new certificates will be generated automatically
4. Reinstall the new CA certificate on client systems

## Certificate Modes

KrakenHashes supports three TLS modes:

1. **self-signed** (default): Automatically generates and manages certificates
2. **provided**: Use your own certificates (set paths via environment variables)
3. **certbot**: Integration with Let's Encrypt for public domains

To change modes, set the `KH_TLS_MODE` environment variable.

## Troubleshooting

### Common Issues and Solutions

#### Browser Still Shows Certificate Warnings

1. **Certificate not properly installed**:
   - Verify the certificate is in the correct store (Trusted Root, not Personal or Intermediate)
   - Check that you installed the CA certificate, not the server certificate
   - Some browsers cache certificate decisions - try clearing browser data or using incognito mode

2. **Browser-specific issues**:
   - **Chrome/Edge**: May require restart after certificate installation
   - **Firefox**: Has its own certificate store - you may need to import via Firefox settings
   - **Safari**: Requires explicit trust settings in Keychain Access

3. **Certificate regenerated**:
   - If the backend regenerated certificates, you need to reinstall the new CA certificate
   - Remove the old certificate first to avoid conflicts

#### ERR_SSL_KEY_USAGE_INCOMPATIBLE (Chrome/Edge)

This error indicates the certificate doesn't have the correct key usage flags. The updated certificate generation should prevent this, but if you encounter it:

1. Ensure you're running the latest version with the certificate improvements
2. Delete existing certificates and let them regenerate
3. As a temporary workaround on Windows:
   ```powershell
   # Create registry key to disable the check (use with caution)
   New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Edge" -Name "RSAKeyUsageForLocalAnchorsEnabled" -Value 0 -PropertyType DWORD
   # For Chrome:
   New-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Google\Chrome" -Name "RSAKeyUsageForLocalAnchorsEnabled" -Value 0 -PropertyType DWORD
   ```

#### Certificate Not Trusted on Linux

1. **Check certificate format**:
   ```bash
   # Verify it's a valid PEM certificate
   openssl x509 -in krakenhashes-ca.crt -text -noout
   ```

2. **Verify installation**:
   ```bash
   # Check if certificate is in the trust store
   trust list | grep -i krakenhashes
   
   # For Debian/Ubuntu, check the symlink was created
   ls -la /etc/ssl/certs/ | grep krakenhashes
   ```

3. **SELinux issues** (RHEL/Fedora):
   ```bash
   # Check for SELinux denials
   sudo ausearch -m avc -ts recent
   
   # If needed, restore context
   sudo restorecon -v /etc/pki/ca-trust/source/anchors/krakenhashes-ca.crt
   ```

#### Certificate Chain Issues

1. **Verify the full chain is being sent**:
   ```bash
   # Check what certificates the server is presenting
   openssl s_client -connect your-server:31337 -showcerts
   ```

2. **Validate certificate chain**:
   ```bash
   # Download server certificate
   echo | openssl s_client -connect your-server:31337 -servername your-server 2>/dev/null | \
     openssl x509 > server.crt
   
   # Verify against CA
   openssl verify -CAfile krakenhashes-ca.crt server.crt
   ```

#### Connection Refused or Timeout

1. **Check the service is running**:
   ```bash
   # Check if ports are listening
   netstat -tlnp | grep -E "1337|31337"
   # or
   ss -tlnp | grep -E "1337|31337"
   ```

2. **Firewall rules**:
   ```bash
   # Check firewall status
   sudo iptables -L -n | grep -E "1337|31337"
   # or for firewalld
   sudo firewall-cmd --list-all
   ```

3. **Docker networking** (if using Docker):
   - Ensure ports are properly mapped in docker-compose.yml
   - Check Docker network connectivity

### Diagnostic Commands

#### View Certificate Details
```bash
# View CA certificate details
openssl x509 -in krakenhashes-ca.crt -text -noout

# Check certificate dates
openssl x509 -in krakenhashes-ca.crt -noout -dates

# Check certificate subject and issuer
openssl x509 -in krakenhashes-ca.crt -noout -subject -issuer
```

#### Test TLS Connection
```bash
# Test with curl (verbose)
curl -v https://your-server:31337/health

# Test with openssl
openssl s_client -connect your-server:31337 -CAfile krakenhashes-ca.crt

# Test cipher suites
nmap --script ssl-enum-ciphers -p 31337 your-server
```

#### Browser Certificate Debugging

1. **Chrome**: Navigate to `chrome://settings/certificates` to manage certificates
2. **Firefox**: Navigate to `about:preferences#privacy` > View Certificates
3. **Edge**: Navigate to `edge://settings/privacy` > Manage certificates

### Removing Old Certificates

If you need to remove old certificates before installing new ones:

**Arch Linux:**
```bash
# Find and remove the certificate
sudo rm -f /etc/ca-certificates/trust-source/anchors/krakenhashes-ca.crt
sudo update-ca-trust

# Or use trust anchor to remove by name
sudo trust anchor --remove "KrakenHashes Root CA"

# Remove from Chrome/Chromium
certutil -d sql:$HOME/.pki/nssdb -D -n "KrakenHashes Root CA"
```

**Debian/Ubuntu:**
```bash
sudo rm /usr/local/share/ca-certificates/krakenhashes-ca.crt
sudo update-ca-certificates --fresh
```

**Fedora/RHEL:**
```bash
sudo rm /etc/pki/ca-trust/source/anchors/krakenhashes-ca.crt
sudo update-ca-trust
```

### Getting Help

If you're still experiencing issues:

1. Check the backend logs for certificate generation errors:
   ```bash
   grep -i "certificate\|tls\|ssl" /path/to/backend.log
   ```

2. Ensure your environment variables are set correctly
3. Try regenerating certificates with a clean state
4. Report issues at: https://github.com/ZerkerEOD/krakenhashes/issues