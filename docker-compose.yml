services:
    postgres:
        image: postgres:15-alpine
        container_name: krakenhashes-postgres
        # PostgreSQL memory configuration (defaults optimized for 8GB RAM systems)
        # Override in .env file for different system configurations
        # See docs/reference/system-requirements.md for detailed guidance
        #
        # WARNING: PostgreSQL file logging is DISABLED by default for security.
        # Enabling it may log sensitive data (queries containing passwords, hashes, etc.)
        # Only enable for debugging, and remember to purge logs afterward via Admin > Diagnostics.
        # To enable file logging, uncomment the logging_collector lines below and restart postgres.
        command: >
            postgres
            -c shared_buffers=${POSTGRES_SHARED_BUFFERS:-1GB}
            -c work_mem=${POSTGRES_WORK_MEM:-256MB}
            -c effective_cache_size=${POSTGRES_EFFECTIVE_CACHE_SIZE:-4GB}
            -c maintenance_work_mem=${POSTGRES_MAINTENANCE_WORK_MEM:-256MB}
            -c max_connections=${POSTGRES_MAX_CONNECTIONS:-100}
            -c enable_parallel_hash=${POSTGRES_ENABLE_PARALLEL_HASH:-off}
            -c hash_mem_multiplier=${POSTGRES_HASH_MEM_MULTIPLIER:-1}
        # Uncomment below to enable PostgreSQL file logging (SECURITY WARNING - see above):
        #   -c logging_collector=on
        #   -c log_directory='/var/log/postgresql'
        #   -c log_filename='postgresql.log'
        #   -c log_statement='all'
        #   -c log_min_duration_statement=0
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ${LOG_DIR:-./logs}/postgres:/var/log/postgresql
        environment:
            - POSTGRES_USER=${DB_USER:-krakenhashes}
            - POSTGRES_PASSWORD=${DB_PASSWORD:-krakenhashes}
            - POSTGRES_DB=${DB_NAME:-krakenhashes}
            - PGDATA=/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-krakenhashes}"]
            interval: 5s
            timeout: 5s
            retries: 5
        restart: unless-stopped
        networks:
            - krakenhashes-net

    krakenhashes:
        image: zerkereod/krakenhashes:latest
        container_name: krakenhashes-app
        depends_on:
            postgres:
                condition: service_healthy
        env_file:
            - .env
        ports:
            - "${FRONTEND_PORT:-443}:443"
            - "${KH_HTTPS_PORT:-31337}:31337"
            - "${KH_PORT:-1337}:1337"
            - "80:80"  # Required for HTTP-01 ACME challenges
        volumes:
            - krakenhashes_data:/var/lib/krakenhashes
            - ${LOG_DIR:-./logs}:/var/log/krakenhashes
            - ${KH_CONFIG_DIR_HOST:-./config}:/etc/krakenhashes
            - ${KH_DATA_DIR_HOST:-./data}:/var/lib/krakenhashes
        environment:
            - TZ=UTC
            - PUID=${PUID:-1000}
            - PGID=${PGID:-1000}
            - DB_HOST=${DB_HOST:-postgres}
            - DB_PORT=${DB_PORT:-5432}
            - DB_NAME=${DB_NAME:-krakenhashes}
            - DB_USER=${DB_USER:-krakenhashes}
            - DB_PASSWORD=${DB_PASSWORD:-krakenhashes}
        restart: unless-stopped
        networks:
            - krakenhashes-net

networks:
    krakenhashes-net:
        driver: bridge

volumes:
    postgres_data:
        name: krakenhashes_postgres_data
    krakenhashes_data:
        name: krakenhashes_app_data
